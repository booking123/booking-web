/* Copyright CBT Limited London - may only used with http://razor-cloud.com services */
(function(a){function f(b){return a.datepicker.formatDate("yy-mm-dd",b)}var b={pos:"",productid:"",dateformat:"d",numberformat:"c",is_available:"Available",not_available:"Not Available",welcome:"Welcome back",changeMonth:!0,changeYear:!0,notowner:!0,error:!0},h=[],i=[],g={init:function(d){b=a.extend(b,d);localize(function(d){a("#cbt_fromdate, #cbt_todate").datepicker({changeMonth:b.changeMonth,changeYear:b.changeYear,dateFormat:dateFormat(b.dateformat),onSelect:function(){var c=a("#cbt_fromdate").datepicker("getDate"),
e=a("#cbt_todate").datepicker("getDate"),j=d.currency;b.error&&console.log("quote "+jsonURL()+", "+b.pos+", "+b.productid+", "+c+", "+e);c&&e&&(e=new Date(e.getFullYear(),e.getMonth(),e.getDate()+1),a("#cbt_todate").val(formatted(e,b.dateformat,culture(j))),a("#cbt_loader").show(),a.getJSON(jsonURL(),{service:"quote",pos:b.pos,productid:b.productid,fromdate:f(c),todate:f(e)},function(c){a("#cbt_loader").hide();void 0!=c.message&&console.log(c.message);a("#cbt_price").html(formatted(c.price,b.numberformat,
culture(c.currency)));a("#cbt_quote").html(formatted(c.quote,b.numberformat,culture(c.currency)));a("#cbt_deposit").html(c.deposit.toFixed(0)+"%");if(c.available){a("#cbt_status").html(b.is_available);var e=c.quote*c.deposit/100;a("#cbt_payment").html(formatted(e,b.numberformat,culture(c.currency)));a("body").data("amount",e)}else a("#cbt_status").html(b.not_available)}).error(function(){b.error&&console.log("quote error")}))},beforeShowDay:function(b){b=a.datepicker.formatDate("yy-mm-dd",b);b=a.inArray(b,
h);return-1==b?[!0,""]:[!1,i[b]]}})});return this.each(function(){var d=a.datepicker.formatDate("yy-mm-01",new Date);b.error&&console.log("book "+b.pos+", "+b.productid+", "+d+", "+b.dateformat+", "+b.numberformat);a("#cbt_loader").show();a.getJSON(jsonURL(),{service:"calendar",pos:b.pos,productid:b.productid,date:d},function(c){a("#cbt_loader").hide();c.message?b.error&&console.log(c.message):a.each(c.items,function(a,b){h.push(b.date);i.push(b.state)})}).error(function(){b.error&&console.log("calendar error")});
a("#cbt_book_form").validate({debug:!1,invalidHandler:function(b,e){e.numberOfInvalids()?(a("#cbt_error").html("Please enter the highlighted field(s)"),a("#cbt_error").show()):a("#cbt_error").hide()},ignore:".ignore",rules:{cbt_fromdate:{required:!0,date:!0},cbt_todate:{required:!0,date:!0},cbt_emailaddress:{required:!0,email:!0},cbt_familyname:{required:!0},cbt_cardholder:{required:"#cbt_cardholder:visible",minlength:5},cbt_cardnumber:{required:"#cbt_cardnumber:visible",creditcard:"#cbt_cardnumber:visible"},
cbt_cardcode:{required:"#cbt_cardcode:visible",minlength:3},cbt_payment:{required:"#cbt_payment:visible",number:!0,min:0,max:1E6}},messages:{cbt_fromdate:{required:"Set the arrival date",date:"Enter a valid date"},cbt_todate:{required:"Set the arrival date",date:"Enter a valid date"},cbt_emailaddress:{required:"Enter an email address",email:"Enter a valid address"},cbt_familyname:{required:"Enter the family or company name"},cbt_cardholder:{required:"Enter the card holder",minlength:"Minimum {0} characters"},
cbt_cardnumber:{required:"Enter the card number",creditcard:"Enter a valid card number"},cbt_cardcode:{required:"Enter the security code",minlength:"Minimum {0} characters"},cbt_payment:{required:"Enter payment amount",number:"Must be a number",min:"Minimum of {0}",max:"Maximum of {0}"}},submitHandler:function(){b.error&&console.log("book submitted "+jsonURL()+", "+b.pos+", "+b.productid+", "+f(a("#cbt_fromdate").datepicker("getDate"))+", "+f(a("#cbt_todate").datepicker("getDate")));a("#cbt_loader").show();
a.getJSON(jsonURL(),{service:"book",pos:b.pos,productid:b.productid,fromdate:f(a("#cbt_fromdate").datepicker("getDate")),todate:f(a("#cbt_todate").datepicker("getDate")),emailaddress:a("#cbt_emailaddress").val(),familyname:a("#cbt_familyname").val(),firstname:a("#cbt_firstname").val(),notes:a("#cbt_notes").val(),cardholder:a("#cbt_cardholder").val(),cardnumber:a("#cbt_cardnumber").val(),cardmonth:a("#cbt_cardmonth").val(),cardyear:a("#cbt_cardyear").val(),cardcode:a("#cbt_cardcode").val(),amount:a("body").data("amount")},
function(b){a("#cbt_loader").hide();a("#cbt_book_form").get(0).reset();b.message?(a("#cbt_message").dialog("open"),a("#cbt_message").html(b.message)):(a("#cbt_popup").dialog("open"),a("#cbt_reservationid").html(b.name))}).error(function(){b.error&&console.log("book error")})}});a("#cbt_emailaddress").change(function(){var c=a("#cbt_emailaddress").val();b.error&&console.log("party "+jsonURL()+", "+b.pos+", "+c);a("#cbt_loader").show();a.getJSON(jsonURL(),{service:"party",method:"exists",pos:b.pos,
emailaddress:c,productid:b.productid},function(c){a("#cbt_loader").hide();if(c.name){var d=c.name.split(","),f=d[0],d=2>d.length?"":d[1]+" ";a("#cbt_familyname").val(f);a("#cbt_firstname").val(d);a("#cbt_cardholder").val(d+f);b.welcome&&d&&a("#cbt_notes").val("Welcome back "+d);c.owner?(b.notowner=!1,a("#cbt_price").hide(),a("#cbt_quote").hide(),a("#cbt_deposit").hide(),a("#cbt_payment").hide(),a("#cbt_cardholder").hide(),a("#cbt_cardnumber").hide(),a("#cbt_cardmonth").hide(),a("#cbt_cardyear").hide(),
a("#cbt_cardcode").hide(),a("#cbt_notes").val("")):b.notowner=!0}}).error(function(){b.error&&console.log("email address error")})})})},productid:function(a){b.error&&console.log("productid "+a);b.productid=a;cbt_reset()}};a.fn.book=function(a){if(g[a])return g[a].apply(this,Array.prototype.slice.call(arguments,1));if("object"===typeof a||!a)return g.init.apply(this,arguments);console.log("Method "+a+" does not exist.")}})(jQuery);
